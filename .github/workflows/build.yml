name: ğŸ”¥ Build Khanjar APK (BUILDZOR - Final Version)

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ Ø¨ÛŒÙ„Ø¯ Ø§Ø² Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨

jobs:
  build:
    runs-on: ubuntu-20.04   # â—ï¸â—ï¸ Ø®ÛŒÙ„ÛŒ Ù…Ù‡Ù…: Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ Ù†Ø³Ø®Ù‡ Ù¾Ø§ÛŒØ¯Ø§Ø± Ø§ÙˆØ¨ÙˆÙ†ØªÙˆ â—ï¸â—ï¸
    timeout-minutes: 60
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4 # Ø¨Ù‡ v4 Ø¨Ø±ÙˆØ² Ø´Ø¯
    
    - name: ğŸ Set up Python 3.10
      uses: actions/setup-python@v5 # Ø¨Ù‡ v5 Ø¨Ø±ÙˆØ² Ø´Ø¯
      with:
        python-version: '3.10'
    
    - name: ğŸ’¾ Cache Buildozer & Dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.buildozer
          .buildozer
          ~/.gradle
        key: buildozer-${{ hashFiles('buildozer.spec') }}-${{ runner.os }}-python-${{ matrix.python-version }}-v3 # Ú©Ù„ÛŒØ¯ Ú©Ø´ Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØª
        restore-keys: |
          buildozer-
    
    - name: ğŸ“¦ Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libssl-dev \
          libffi-dev \
          openjdk-17-jdk \
          zlib1g-dev \
          ccache \
          autoconf \
          automake \
          libtool \
          wget \
          unzip
    
    - name: ğŸ”§ Install Pinned Buildozer Stack
      run: |
        pip install --upgrade pip
        # â—ï¸â—ï¸ Ø§ÛŒÙ†Ø¬Ø§ Ú©Ù„ÛŒØ¯ÛŒÙ‡: buildozer Ùˆ python-for-android Ø±Ø§ Ù¾ÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… â—ï¸â—ï¸
        pip install \
          cython==0.29.36 \
          buildozer==1.5.0 \
          python-for-android==2023.09.16
    
    - name: ğŸ“¥ Pre-download Android NDK r25b
      run: |
        mkdir -p ~/.buildozer/android/platform
        cd ~/.buildozer/android/platform
        if [ ! -f "android-ndk-r25b-linux.zip" ]; then
          wget -q https://dl.google.com/android/repository/android-ndk-r25b-linux.zip
          echo "âœ… NDK downloaded"
        else
          echo "âœ… NDK already cached"
        fi
    
    - name: ğŸ—ï¸ Build APK
      run: |
        buildozer -v android debug
    
    - name: ğŸ“¤ Upload APK as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: khanjar-apk
        path: bin/*.apk
    
    - name: âœ… Build Complete
      run: |
        echo "ğŸ‰ APK Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯!"
        ls -lh bin/
